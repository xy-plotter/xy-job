import t from"tiny-emitter";var e="undefined"!=typeof window&&void 0!==window.document,n={black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39]},u={};if(!e){var i=function(t){var e="["+n[t][0]+"m",i="["+n[t][1]+"m";u[t]=function(t){return console.log(e+t+i)}};for(var o in n)i(o)}var r=console.log,s=e?console.log:u.green,h=e?console.warn:u.yellow,a=e?console.error:u.error,p=function(t,e,n,u){return u(e+" "+t+" "+n)},c=function(t){void 0===t&&(t={}),this.prefix="[xy-job]",this.suffix="(job: "+t.job+")"||""};c.prototype.info=function(t){return p(t,this.prefix,this.suffix,r)},c.prototype.warn=function(t){return p(t,this.prefix+" Warning:",this.suffix,h)},c.prototype.error=function(t){return p(t,this.prefix+" Error:",this.suffix,a)},c.prototype.success=function(t){return p(t,this.prefix+" Success:",this.suffix,s)};var d="job",f="",E="_",S=function(t){return+t<10?"0"+t:""+t};function q(t){return t.length>1?t:(e=new Date,n=e.getFullYear(),u=S(e.getMonth()),i=S(e.getDate()),o=S(e.getHours()),r=S(e.getMinutes()),s=S(e.getSeconds()),h=e.getMilliseconds(),a=Math.floor(999999*Math.random()),p="",p+=d+E,p+=n+f+u+f+i,p+=E,p+=o+f+r+f+s,p+=E,p+=h,p+=E,p+=a);var e,n,u,i,o,r,s,h,a,p}var v=function(t){return void 0===t&&(t=2),function(e){void 0===e&&(e=0);var n=(e+"e").split("e");return+((n=(Math.round(n[0]+"e"+(+n[1]+t))+"e").split("e"))[0]+"e"+(+n[1]-t))}},l={HOME:function(){return["HOME"]},MOVE:function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),["MOVE",+t,+e]},PEN:function(t){return void 0===t&&(t=0),["PEN",t]},SPEED:function(t){return void 0===t&&(t=0),["SPEED",+t]},SPEED_RESET:function(){return["SPEED_RESET"]},WAIT:function(t,e){return void 0===t&&(t=""),void 0===e&&(e=""),["WAIT",t+"",e+""]},END:function(){return["END"]}},y=function(t){return"Job instruction "+t+" is invalid."},g=function(t){return"Job already ended. Can't enqueue "+t+" instruction."},b=function(t,e){return"Move to to out-of-bounds coordinates: "+t+";"+e+"."},w=function(){return"Speed value must be between 0 and 1. Leaving speed setting unchanged."},x={name:"",canvasWidth:380,canvasHeight:310,penUp:0,penDown:30,precision:3},M=function(t){function e(e){void 0===e&&(e={}),t.call(this),e=Object.assign({},x,e),this.name=q(e.name),this.round=v(0|e.precision),this.bounds={canvas:[this.round(e.canvasWidth),this.round(e.canvasHeight)],pen:[this.round(e.penUp),this.round(e.penDown)]},this.logger=new c({job:this.name}),this.warn=this.logger.warn.bind(this.logger),this.queue=[],this.queueState={ended:!1,x:0,y:0,pen:this.bounds.pen[0],speed:"auto"},this.reset()}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.canEnqueue=function(t){return this.queueState.ended?this.warn(g(t))&&!1:!(t&&!l[t])||this.warn(y(t))&&!1},e.prototype.enqueue=function(t,e,n){return this.canEnqueue(t)?(isNaN(e)||(e=this.round(e)),isNaN(n)||(n=this.round(n)),"MOVE"===t?(this.queueState.x=e,this.queueState.y=n):"PEN"===t?this.queueState.pen=e:"END"===t?this.queueState.ended=!0:"SPEED_RESET"===t?this.queueState.speed="auto":"SPEED"===t&&(this.queueState.speed=e),this.queue.push(l[t](e,n)),this):this},e.prototype.reset=function(){return this.canEnqueue("HOME")?(this.penUp(!0),this.resetSpeed(),this.queueState.x=0,this.queueState.y=0,this.enqueue("HOME")):this},e.prototype.pen=function(t,e){return this.queueState.pen===this.round(t)&&e?this.enqueue("PEN",t):this},e.prototype.penUp=function(t){return this.pen(this.bounds.pen[0],t)},e.prototype.penDown=function(t){return this.pen(this.bounds.pen[1],t)},e.prototype.setSpeed=function(t){if(void 0===t||"auto"===t||isNaN(t))return this.resetSpeed();if(t<0||t>1)return this.warn(w()),this;var e=1100-1e3*t;return this.queueState.speed!==this.round(e)&&this.enqueue("SPEED",e),this},e.prototype.resetSpeed=function(){return"auto"!==this.queueState.speed&&this.enqueue("SPEED_RESET"),this},e.prototype.move=function(t,e){if(!this.canEnqueue("MOVE"))return this;(t<0||t>this.bounds.canvas[0]||e<0||e>this.bounds.canvas[1])&&this.warn(b(t,e));for(var n=[t-this.queueState.x,e-this.queueState.y],u=Math.max(Math.max(n[0],n[1])/150,1),i=[this.round(n[0]/u),this.round(n[1]/u)];Math.abs(n[0])>150||Math.abs(n[1])>150;)n[0]-=i[0],n[1]-=i[1],this.enqueue("MOVE",this.queueState.x+i[0],this.queueState.y+i[1]);return this.queueState.x===this.round(t)&&this.queueState.y===this.round(e)||this.enqueue("MOVE",t,e),this},e.prototype.wait=function(t,e){return this.enqueue("WAIT",t,e)},e.prototype.end=function(){return this.enqueue("END")},e}(t);export default M;export{M as Job};
