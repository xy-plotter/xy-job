!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.XYJob=e()}(this,function(){function t(){}t.prototype={on:function(t,e,n){var i=this.e||(this.e={});return(i[t]||(i[t]=[])).push({fn:e,ctx:n}),this},once:function(t,e,n){var i=this;function u(){i.off(t,u),e.apply(n,arguments)}return u._=e,this.on(t,u,n)},emit:function(t){for(var e=[].slice.call(arguments,1),n=((this.e||(this.e={}))[t]||[]).slice(),i=0,u=n.length;i<u;i++)n[i].fn.apply(n[i].ctx,e);return this},off:function(t,e){var n=this.e||(this.e={}),i=n[t],u=[];if(i&&e)for(var o=0,r=i.length;o<r;o++)i[o].fn!==e&&i[o].fn._!==e&&u.push(i[o]);return u.length?n[t]=u:delete n[t],this}};var e=t,n="undefined"!=typeof window&&void 0!==window.document,i={black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39]},u={};if(!n){var o=function(t){var e="["+i[t][0]+"m",n="["+i[t][1]+"m";u[t]=function(t){return console.log(e+t+n)}};for(var r in i)o(r)}var s=console.log,h=n?console.log:u.green,a=n?console.warn:u.yellow,p=n?console.error:u.error,f=function(t,e,n,i){return i(e+" "+t+" "+n)},c=function(t){void 0===t&&(t={}),this.prefix="[xy-job]",this.suffix="(job: "+t.job+")"||""};c.prototype.info=function(t){return f(t,this.prefix,this.suffix,s)},c.prototype.warn=function(t){return f(t,this.prefix+" Warning:",this.suffix,a)},c.prototype.error=function(t){return f(t,this.prefix+" Error:",this.suffix,p)},c.prototype.success=function(t){return f(t,this.prefix+" Success:",this.suffix,h)};var d="job",E="",l="_",v=function(t){return+t<10?"0"+t:""+t};function S(t){return t.length>1?t:(e=new Date,n=e.getFullYear(),i=v(e.getMonth()),u=v(e.getDate()),o=v(e.getHours()),r=v(e.getMinutes()),s=v(e.getSeconds()),h=e.getMilliseconds(),a=Math.floor(999999*Math.random()),p="",p+=d+l,p+=n+E+i+E+u,p+=l,p+=o+E+r+E+s,p+=l,p+=h,p+=l,p+=a);var e,n,i,u,o,r,s,h,a,p}var q=function(t){return void 0===t&&(t=2),function(e){void 0===e&&(e=0);var n=(e+"e").split("e");return+((n=(Math.round(n[0]+"e"+(+n[1]+t))+"e").split("e"))[0]+"e"+(+n[1]-t))}},y={HOME:function(){return["HOME"]},MOVE:function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),["MOVE",+t,+e]},PEN:function(t){return void 0===t&&(t=0),["PEN",t]},SPEED:function(t){return void 0===t&&(t=0),["SPEED",+t]},SPEED_RESET:function(){return["SPEED_RESET"]},WAIT:function(t,e){return void 0===t&&(t=""),void 0===e&&(e=""),["WAIT",t+"",e+""]},END:function(){return["END"]}},g=function(t){return"Job instruction "+t+" is invalid."},b=function(t){return"Job already ended. Can't enqueue "+t+" instruction."},x=function(t,e){return"Move to to out-of-bounds coordinates: "+t+";"+e+"."},w=function(){return"Speed value must be between 0 and 1. Leaving speed setting unchanged."},M={name:"",canvasWidth:380,canvasHeight:310,penUp:0,penDown:30,precision:3};return function(t){function e(e){void 0===e&&(e={}),t.call(this),e=Object.assign({},M,e),this.name=S(e.name),this.round=q(0|e.precision),this.bounds={canvas:[this.round(e.canvasWidth),this.round(e.canvasHeight)],pen:[this.round(e.penUp),this.round(e.penDown)]},this.logger=new c({job:this.name}),this.warn=this.logger.warn.bind(this.logger),this.queue=[],this.queueState={ended:!1,x:0,y:0,pen:this.bounds.pen[0],speed:"auto"},this.reset()}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e.prototype.canEnqueue=function(t){return this.queueState.ended?this.warn(b(t))&&!1:!(t&&!y[t])||this.warn(g(t))&&!1},e.prototype.enqueue=function(t,e,n){return this.canEnqueue(t)?(isNaN(e)||(e=this.round(e)),isNaN(n)||(n=this.round(n)),"MOVE"===t?(this.queueState.x=e,this.queueState.y=n):"PEN"===t?this.queueState.pen=e:"END"===t?this.queueState.ended=!0:"SPEED_RESET"===t?this.queueState.speed="auto":"SPEED"===t&&(this.queueState.speed=e),this.queue.push(y[t](e,n)),this):this},e.prototype.reset=function(){return this.canEnqueue("HOME")?(this.penUp(!0),this.resetSpeed(),this.queueState.x=0,this.queueState.y=0,this.enqueue("HOME")):this},e.prototype.pen=function(t){return this.queueState.pen!==this.round(t)?this:this.enqueue("PEN",t)},e.prototype.penUp=function(){return this.pen(this.bounds.pen[0])},e.prototype.penDown=function(){return this.pen(this.bounds.pen[1])},e.prototype.setSpeed=function(t){if(void 0===t||"auto"===t||isNaN(t))return this.resetSpeed();if(t<0||t>1)return this.warn(w()),this;var e=1100-1e3*t;return this.queueState.speed!==this.round(e)&&this.enqueue("SPEED",e),this},e.prototype.resetSpeed=function(){return"auto"!==this.queueState.speed&&this.enqueue("SPEED_RESET"),this},e.prototype.move=function(t,e){if(!this.canEnqueue("MOVE"))return this;(t<0||t>this.bounds.canvas[0]||e<0||e>this.bounds.canvas[1])&&this.warn(x(t,e));for(var n=[t-this.queueState.x,e-this.queueState.y],i=Math.max(Math.max(n[0],n[1])/150,1),u=[this.round(n[0]/i),this.round(n[1]/i)];Math.abs(n[0])>150||Math.abs(n[1])>150;)n[0]-=u[0],n[1]-=u[1],this.enqueue("MOVE",this.queueState.x+u[0],this.queueState.y+u[1]);return this.queueState.x===this.round(t)&&this.queueState.y===this.round(e)||this.enqueue("MOVE",t,e),this},e.prototype.wait=function(t,e){return this.enqueue("WAIT",t,e)},e.prototype.end=function(){return this.enqueue("END")},e}(e)});
